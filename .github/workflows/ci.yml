name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  frontend-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: frontend
      run: npm ci

    - name: Lint
      id: lint
      working-directory: frontend
      run: npm run lint
      continue-on-error: true

    - name: Typecheck
      id: typecheck
      if: always()
      working-directory: frontend
      run: npm run typecheck
      continue-on-error: true

    - name: Run Tests
      id: test
      if: always()
      working-directory: frontend
      run: npm run test:coverage || exit 1 # Fail if tests fail, but run if prev steps failed?
      # Actually, vitest coverage fails exit 1 on threshold.
      continue-on-error: true

    - name: Build
      id: build
      if: always()
      working-directory: frontend
      run: npm run build
      continue-on-error: true

    - name: Check Status
      if: always()
      run: |
        if [ "${{ steps.lint.outcome }}" == "failure" ] || [ "${{ steps.typecheck.outcome }}" == "failure" ] || [ "${{ steps.test.outcome }}" == "failure" ] || [ "${{ steps.build.outcome }}" == "failure" ]; then
          exit 1
        fi

  backend-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r ../requirements.txt
        pip install ruff mypy pytest pytest-cov httpx

    - name: Lint with Ruff
      id: ruff
      working-directory: backend
      run: ruff check . --output-format=github
      continue-on-error: true

    - name: Typecheck with Mypy
      id: mypy
      if: always()
      working-directory: backend
      run: mypy .
      continue-on-error: true

    - name: Run Tests
      id: pytest
      if: always()
      working-directory: backend
      run: pytest --cov=app --cov-report=term-missing --cov-fail-under=50 tests/

    - name: Check Status
      if: always()
      run: |
        if [ "${{ steps.ruff.outcome }}" == "failure" ] || [ "${{ steps.mypy.outcome }}" == "failure" ] || [ "${{ steps.pytest.outcome }}" == "failure" ]; then
          echo "One or more steps failed."
          exit 1
        fi
